# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    Makefile                                           :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: hmunoz-g <hmunoz-g@student.42.fr>          +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2025/11/13 00:00:00 by hmunoz-g          #+#    #+#              #
#    Updated: 2025/11/13 13:50:41 by hmunoz-g         ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

# -=-=-=-=-    COLOURS -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #

DEF_COLOR   = \033[0;39m
YELLOW      = \033[0;93m
CYAN        = \033[0;96m
GREEN       = \033[0;92m
BLUE        = \033[0;94m
RED         = \033[0;91m

# -=-=-=-=-    NAME -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= #

NAME        := computor
PROJECT     := computorv1

# -=-=-=-=-    DOTNET SETTINGS -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #

DOTNET      = dotnet
BUILD_FLAGS = --configuration Release --verbosity quiet
RUN_FLAGS   = --no-build --configuration Release
PUBLISH_FLAGS = --configuration Release --self-contained false

# -=-=-=-=-    PATH -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #

RM          = rm -fr
BUILD_DIR   = bin
OBJ_DIR     = obj
PUBLISH_DIR = publish

# -=-=-=-=-    FILES -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #

CSPROJ      = $(PROJECT).csproj
SOURCES     = $(shell find . -name "*.cs" 2>/dev/null)
EXECUTABLE  = $(BUILD_DIR)/Release/net8.0/$(PROJECT)

# -=-=-=-=-    TARGETS -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #

all: $(NAME)

$(NAME): $(SOURCES) $(CSPROJ)
	@echo "$(YELLOW)Building $(PROJECT)...$(DEF_COLOR)"
	@$(DOTNET) build $(BUILD_FLAGS)
	@if [ -f "$(EXECUTABLE)" ]; then \
		ln -sf $(EXECUTABLE) $(NAME) 2>/dev/null || cp $(EXECUTABLE) $(NAME); \
		echo "$(GREEN)$(NAME) compiled!$(DEF_COLOR)"; \
	elif [ -f "$(EXECUTABLE).dll" ]; then \
		echo "#!/bin/bash" > $(NAME); \
		echo "$(DOTNET) \"$(PWD)/$(EXECUTABLE).dll\" \"\$$@\"" >> $(NAME); \
		chmod +x $(NAME); \
		echo "$(GREEN)$(NAME) script created!$(DEF_COLOR)"; \
	else \
		echo "$(RED)Build failed - executable not found$(DEF_COLOR)"; \
		exit 1; \
	fi
	@echo "$(RED)Zen in the art of polynomials$(DEF_COLOR)"

build: $(NAME)

run: $(NAME)
	@echo "$(CYAN)Running $(NAME)...$(DEF_COLOR)"
	@$(DOTNET) run $(RUN_FLAGS)

test: $(NAME)
	@echo "$(CYAN)Running tests...$(DEF_COLOR)"
	@if [ -f "run_tests.sh" ]; then \
		./run_tests.sh; \
	else \
		echo "$(YELLOW)No test script found$(DEF_COLOR)"; \
	fi

publish: $(SOURCES) $(CSPROJ)
	@echo "$(YELLOW)Publishing $(PROJECT)...$(DEF_COLOR)"
	@$(DOTNET) publish $(PUBLISH_FLAGS) -o $(PUBLISH_DIR)
	@echo "$(GREEN)Published to $(PUBLISH_DIR)$(DEF_COLOR)"

restore:
	@echo "$(YELLOW)Restoring dependencies...$(DEF_COLOR)"
	@$(DOTNET) restore
	@echo "$(GREEN)Dependencies restored$(DEF_COLOR)"

clean:
	@echo "$(YELLOW)Cleaning build artifacts...$(DEF_COLOR)"
	@$(DOTNET) clean --verbosity quiet 2>/dev/null || true
	@$(RM) $(BUILD_DIR) $(OBJ_DIR)
	@echo "$(RED)Cleaned object files and build artifacts$(DEF_COLOR)"

fclean: clean
	@$(RM) $(NAME) $(PUBLISH_DIR)
	@echo "$(RED)Cleaned all binaries$(DEF_COLOR)"

re: fclean all

format:
	@echo "$(CYAN)Formatting code...$(DEF_COLOR)"
	@$(DOTNET) format --verbosity quiet || echo "$(YELLOW)dotnet format not available$(DEF_COLOR)"

check:
	@echo "$(CYAN)Checking project...$(DEF_COLOR)"
	@$(DOTNET) build --dry-run $(BUILD_FLAGS)

info:
	@echo "$(BLUE)Project Information:$(DEF_COLOR)"
	@echo "  Name: $(NAME)"
	@echo "  Project: $(PROJECT)"
	@echo "  .NET Version: $$($(DOTNET) --version 2>/dev/null || echo 'Not installed')"
	@echo "  Sources: $$(echo '$(SOURCES)' | wc -w) files"

help:
	@echo "$(BLUE)Available targets:$(DEF_COLOR)"
	@echo "  $(GREEN)all$(DEF_COLOR)      - Build the project (default)"
	@echo "  $(GREEN)build$(DEF_COLOR)    - Build the project"
	@echo "  $(GREEN)run$(DEF_COLOR)      - Build and run the project"
	@echo "  $(GREEN)test$(DEF_COLOR)     - Run the test suite"
	@echo "  $(GREEN)publish$(DEF_COLOR)  - Publish for distribution"
	@echo "  $(GREEN)restore$(DEF_COLOR)  - Restore NuGet dependencies"
	@echo "  $(GREEN)clean$(DEF_COLOR)    - Clean build artifacts"
	@echo "  $(GREEN)fclean$(DEF_COLOR)   - Clean everything"
	@echo "  $(GREEN)re$(DEF_COLOR)       - Clean and rebuild"
	@echo "  $(GREEN)format$(DEF_COLOR)   - Format source code"
	@echo "  $(GREEN)check$(DEF_COLOR)    - Dry-run build check"
	@echo "  $(GREEN)info$(DEF_COLOR)     - Show project information"
	@echo "  $(GREEN)help$(DEF_COLOR)     - Show this help"

.PHONY: all build run test publish restore clean fclean re format check info help

# -=-=-=-=-    SPECIAL RULES -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #

# Ensure .NET is installed
check-dotnet:
	@which $(DOTNET) > /dev/null || (echo "$(RED)Error: .NET is not installed$(DEF_COLOR)" && exit 1)

$(NAME): check-dotnet

# Auto-dependency tracking (rebuild if .cs files change)
$(BUILD_DIR)/Release/net8.0/$(PROJECT): $(SOURCES)
	@$(MAKE) build

# Prevent deletion of intermediate files
.PRECIOUS: $(BUILD_DIR)/Release/net8.0/$(PROJECT)